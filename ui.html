<link rel="stylesheet" href="https://static.figma.com/api/figma-extension-api-0.0.1.css">
<style>
  :root {
    --pink: hsl(330, 100%, 60%);
    --blue: hsl(192, 100%, 60%);
    --grey: hsl(240, 28%, 77%);
    --green: hsl(148, 100%, 41%);
    --purple: hsl(280, 100%, 70%);
    --yellow: hsl(40, 100%, 70%);
    --turquoise: hsl(181, 100%, 41%);
    --midnight-sky: hsl(240, 13%, 13%);
    --overcast-sky: hsl(240, 13%, 81%);
    --tangerine: hsl(40, 100%, 50%);
    --red: hsl(336, 89%, 50%);

    --black: rgb(0, 0, 0);
    --grey_50: rgb(11, 11, 15);
    --grey_100: rgb(22, 22, 29);
    --grey_200: rgb(44, 44, 58);
    --grey_300: rgb(66, 66, 87);
    --grey_400: rgb(88, 88, 116);
    --grey_500: rgb(110, 110, 145);
    --grey_600: rgb(139, 139, 167);
    --grey_700: rgb(168, 168, 189);
    --grey_800: rgb(197, 197, 211);
    --grey_900: rgb(226, 226, 233);
    --grey_950: rgb(241, 241, 244);
    --white: rgb(255, 255, 255);
  }


  body {
    font-family: Inter, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, Fira Sans, Droid Sans, Helvetica Neue, sans-serif;
    line-height: 1.6;
  }

  button.danger {
    color: #fff;
    background-color: var(--red);
    border-color: var(--red);
  }

  button.white {
    color: var(--grey_50);
    background-color: #fff;
    border-color: #fff;
  }

  button.small {
    height: 20px;
    line-height: 1.6;
    max-width: 180px;
    padding: 0 8px;
  }

  .tabs {
    background: var(--grey_900);
    display: flex;
    padding: 10px 10px 0;
    gap: 1em;
    margin-bottom: 16px;
  }

  .tab {
    padding: 6px 10px;
    color: var(--pink);
    text-decoration: none;
    background: var(--grey_950);
    border: 1px solid var(--grey_800);
    border-bottom: 0;
  }

  .tab--active {
    background: var(--white);
    color: var(--grey_50);
    font-weight: 700;
    cursor: default;
  }

  .flex {
    display: flex;
  }

  .text-center {
    text-align: center;
  }

  .form-section {
    margin: 14px 0;
  }

  .button-layout {
    display: flex;
    gap: 0.5em;
  }

  .add-color-form {
    display: flex;
    align-items: center;
    gap: 0.5em;
  }

  /* .form-field {

  }

  .form-label {
    font-weight: 700;
    display: block;
  } */

  .swatches {
    display: flex;
    flex-wrap: wrap;
  }

  .swatch {
    width: 20%;
    width: 16.666667%;
    height: 80px;
    padding: 6px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    flex-wrap: wrap;
    align-items: start;
  }

  .swatch__label {
    background: var(--grey_50);
    color: var(--white);
    padding: 0.25em 0.5em;
    display: inline-block;
    font-size: 0.7rem;
  }

  .code-layout {
    display: flex;
    flex-wrap: wrap;
    gap: 1em;
  }

  .code-layout__title {
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .code-layout__item {
    width: 48%;
    flex-grow: 1;
  }

  .code-wrapper {
    overflow: hidden;
    border-radius: 8px;
  }

  .code-block {
    background: var(--grey_950);
    padding: 10px;
    box-sizing: border-box;
    max-width: 100%;
    overflow-x: scroll;
    margin: 0;
    scrollbar-width: thin;
  }
</style>

<script type="module">
  import { createApp, reactive } from 'https://unpkg.com/petite-vue@0.4.1/dist/petite-vue.es.js?module'

  const store = reactive({
    codeBlocks: [],
    setCodeBlocks(data) {
      this.codeBlocks = data
    },
  })

  window.addEventListener('message', ({ data }) => {
    switch (data.pluginMessage.type) {
      case 'local-styles':
        return store.setCodeBlocks(
          getGeneratedCodeForColours(data.pluginMessage.data)
        )
      default:
        // nothing
    }
  }, false)

  const getDefaultColour = () => getColourScheme() === 'dark' ? '#000000' : '#FFFFFF'

  createApp({
    store,

    activeTab: 'palettes',

    paletteName: '',

    currentColorName: '',
    currentColorHex: getDefaultColour(),

    colors: [
      // test colour palette
      // { name: "pink", hex: "#ff3399" },
      // { name: "blue", hex: "#33d5ff" },
      // { name: "grey", hex: "#b3b3d4" },
      // { name: "green", hex: "#00d364" },
      // { name: "purple", hex: "#cc66ff" },
      // { name: "yellow", hex: "#ffcc66" },
      // { name: "turquoise", hex: "#00ced1" },
      // { name: "midnight-sky", hex: "#1d1d26" },
      // { name: "overcast-sky", hex: "#c8c8d5" },
      // { name: "tangerine", hex: "#ffaa00" },
      // { name: "red", hex: "#f10f69" }
    ],

    // codeBlocks: [],

    /* get codeBlocks() {
      console.log('store code blocks', toObject(this.store))
      return getGeneratedCodeForColours(toObject(this.colors))
    }, */

    addColor() {
      if (!this.currentColorName) {
        alert('colour name required')
        return
      }

      this.colors.push({
        name: this.currentColorName,
        hex: this.currentColorHex,
      })

      this.currentColorName = ''
      this.currentColorHex = getDefaultColour()
    },

    removeColor(hex) {
      this.colors = this.colors.filter((color) => color.hex !== hex)
    },

    resetPalette() {
      this.colors = []
    },

    copyCodeToClipboard(codeBlock) {
      copyTextToClipboard(codeBlock.comment + '\n' + codeBlock.code, (success) => {
        const alertMessage = success ?
          `successfully copied "${codeBlock.name}" code to clipboard` :
          `failed to copy "${codeBlock.name}" code to clipboard`

        alert(alertMessage)
      })
    },

    refreshLocalStyles() {
      parent.postMessage({
        pluginMessage: {
          type: 'refresh-local-styles',
          data: {},
        }
      }, '*')
    },

    /**
     * Create a colour palette from the picked colours
     */
    createColorPalette() {
      if (!this.colors.length) {
        alert('must add at least 1 colour to generate a palette')
        return
      }

      const colourScheme = getColourScheme()

      const paletteName = this.paletteName.toString()
      if (!paletteName) {
        alert('must name the colour palette')
        return
      }

      const colours = this.colors.map((color) => ({
        name: color.name,
        hex: color.hex,
      }))

      parent.postMessage({
        pluginMessage: {
          type: 'create-palette',
          data: {
            paletteName,
            colourScheme,
            colours,
          },
        }
      }, '*')
    },
  }).mount()


  /* document.getElementById('create-palette').addEventListener('click', (evt) => {
    const colourScheme = getColourScheme()

    parent.postMessage({
      pluginMessage: {
        type: 'create-palette',
        data: {
          paletteName: 'Tinacious Design',
          count: 12,
          colourScheme,
          colours: this.colors,
        },
      }
    }, '*')
  }) */

  /* document.getElementById('export-palette').addEventListener('click', (evt) => {
    parent.postMessage({
      pluginMessage: {
        type: 'export-palette',
        data: {},
      }
    }, '*')
  }) */

  /* const showError = errorMessage => {
    document.querySelector('#errors').textContent = errorMessage
  }
  document.getElementById('bar-chart').addEventListener('click', (evt) => {
    const text = document.querySelector('#textbox').value

    let numbers = text.split(',').map(x => +x)
    if (numbers.length < 2) {
      showError('Error: Must have at least two values');
      return
    }
    if (numbers.some(x => isNaN(x))) {
      showError('Error: All values must be numbers');
      return
    }

    parent.postMessage({
      pluginMessage: {
        type: 'graph',
        data: numbers,
      }
    }, '*')
  }) */


  /**
   * Gets the user's preferred colour scheme. We can use this to generate a dynamic background colour, if necessary
   * @returns 'light' | 'dark'
   */
  function getColourScheme() {
    return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
  }

  function dataFromForm(formElement) {
    const formData = new FormData(formElement)
    return formData.entries()
  }

  function getGeneratedCodeForColours(colours, topComment) {
    const copiedComment = `Colours generated with: https://github.com/tinacious/colour-tools-figma`
    const codeBlocks = []

    // Generate code for Android (XML)
    const androidXmlCode = []
    colours.forEach((swatch) => {
      androidXmlCode.push(`<color name="${swatch.name}">${swatch.hex}</color>`)
    })
    codeBlocks.push({
      name: 'Android (XML)',
      comment: `<!-- ${copiedComment} -->`,
      code: androidXmlCode.join('\n'),
    })

    // Generate code for Android (Jetpack Compose)
    const androidComposeCode = [
      'object Shades {'
    ]
    colours.forEach((swatch) => {
      androidComposeCode.push(`    val ${swatch.name} = Color(0xFF${swatch.hex.toUpperCase().replace('#', '')})`)
    })
    androidComposeCode.push('}')
    codeBlocks.push({
      name: 'Android (Jetpack Compose)',
      comment: `// ${copiedComment}`,
      code: androidComposeCode.join('\n'),
    })

    // Generate Tailwind config
    const tailwindCode = []
    // const tailwindCode = ['colors: {']
    colours.forEach((swatch) => {
      tailwindCode.push(`  ${swatch.name}: '${swatch.hex}',`)
    })
    // tailwindCode.push('}')

    codeBlocks.push({
      name: 'Tailwind "colors" configuration',
      comment: `// ${copiedComment}`,
      code: tailwindCode.join('\n'),
    })

    // Generate CSS code (hex)
    const cssCodeHex = [':root {']
    colours.forEach((swatch) => {
      cssCodeHex.push(`  --${swatch.name}: ${swatch.hex};`)
    })
    cssCodeHex.push('}')

    codeBlocks.push({
      name: 'CSS (hex)',
      comment: `/* ${copiedComment} */`,
      code: cssCodeHex.join('\n'),
    })

    // Generate CSS code (hsl)
    const cssCodeHsl = [':root {']
    colours.forEach((swatch) => {
      const { h, s, l } = hexToHsl(swatch.hex)
      const hslCss = `hsl(${(h * 360).toFixed(0)}, ${(s * 100).toFixed(0)}%, ${(l * 100).toFixed(0)}%)`

      cssCodeHsl.push(`  --${swatch.name}: ${hslCss};`)
    })
    cssCodeHsl.push('}')

    codeBlocks.push({
      name: 'CSS (HSL)',
      comment: `/* ${copiedComment} */`,
      code: cssCodeHsl.join('\n'),
    })

    // Generate CSS code (rgb)
    const cssCodeRgb = [':root {']
    colours.forEach((swatch) => {
      const { r, g, b } = hexToWebRGB(swatch.hex)
      const rgbCss = `rgb(${(r).toFixed(0)}, ${(g).toFixed(0)}, ${(b).toFixed(0)})`

      cssCodeRgb.push(`  --${swatch.name}: ${rgbCss};`)
    })
    cssCodeRgb.push('}')

    codeBlocks.push({
      name: 'CSS (RGB)',
      comment: `/* ${copiedComment} */`,
      code: cssCodeRgb.join('\n'),
    })

    // Generate CSS code for SASS (SCSS)
    const scssCode = []
    colours.forEach((swatch) => {
      scssCode.push('$' + swatch.name + `: ${swatch.hex};`)
    })
    codeBlocks.push({
      name: 'Sass (SCSS)',
      comment: `// ${copiedComment}`,
      code: scssCode.join('\n'),
    })

    // Generate CSS code for Stylus
    const stylusCssCode = []
    colours.forEach((swatch) => {
      stylusCssCode.push(`${swatch.name} = ${swatch.hex}`)
    })
    codeBlocks.push({
      name: 'Sass (Stylus)',
      comment: `// ${copiedComment}`,
      code: stylusCssCode.join('\n'),
    })

    return codeBlocks
  }

  function toObject(proxy) {
    return JSON.parse(JSON.stringify(proxy))
  }

  function copyTextToClipboard(text, callback) {
    if (!navigator.clipboard) {
      fallbackCopyTextToClipboard(text, callback);
      return;
    }
    navigator.clipboard.writeText(text).then(function () {
      callback(true)
    }, function (err) {
      console.error('async: failed to copy', err);
      callback(false)
    });
  }

  function fallbackCopyTextToClipboard(text, callback) {
    var textArea = document.createElement("textarea");
    textArea.value = text;

    // Avoid scrolling to bottom
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
      document.execCommand('copy');
      callback(true)
    } catch (err) {
      console.error('fallback: failed to copy', err);
      callback(false)
    }

    document.body.removeChild(textArea);
  }

  function hexToWebRGB(hex) {
    const r = parseInt(hex.substr(1, 2), 16)
    const g = parseInt(hex.substr(3, 2), 16)
    const b = parseInt(hex.substr(5, 2), 16)

    return { r, g, b }
  }

  function hexToHsl(hex) {
    let { r, g, b } = hexToWebRGB(hex)

    r /= 255, g /= 255, b /= 255;
    let max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;

    if (max == min) {
      h = s = 0; // achromatic
    } else {
      var d = max - min;
      s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
      switch (max) {
        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
        case g: h = (b - r) / d + 2; break;
        case b: h = (r - g) / d + 4; break;
      }
      h /= 6;
    }

    return { h, s, l };
  }
</script>

<div v-scope>
  <div class="tabs">
    <a href="#" class="tab" @click="activeTab = 'palettes'" :class="{ 'tab--active': activeTab === 'palettes'}">
      Colour Palettes
    </a>
    <a href="#" class="tab" @click="activeTab = 'shades'" :class="{ 'tab--active': activeTab === 'shades'}">
      Shades
    </a>
    <a href="#" class="tab" @click="activeTab = 'code'" :class="{ 'tab--active': activeTab === 'code'}">
      Styles Code
    </a>
  </div>

  <div v-if="activeTab === 'palettes'">
    <h2>Add colour</h2>

    <h3>Palette Name</h3>
    <div class="form-section">
      <input type="text" v-model="paletteName" placeholder="Palette name" autofocus>
    </div>

    <h3>Add colour</h3>
    <form id="add-color-form" class="add-color-form" @submit.prevent="">
      <input type="text" placeholder="Colour name" name="color_name" v-model="currentColorName">
      <input type="color" name="picked_color" v-model="currentColorHex">
      <input type="text" name="picked_color" v-model="currentColorHex">
      <button type="submit" @click="addColor">Add Colour</button>
    </form>

    <div v-if="colors.length" class="swatches form-section">
      <div v-for="color in colors" class="swatch" :style="{ background: color.hex }">
        <span class="swatch__label">{{color.name}}</span>

        <button @click="removeColor(color.hex)" title="Delete colour" class="small white">
          🗑️
        </button>
      </div>
    </div>
    <div v-if="colors.length" class="form-section button-layout">
      <button class="primary" @click="createColorPalette">Create Palette</button>
      <button @click="resetPalette">Reset</button>
    </div>

    <div v-if="!colors.length">
      <p class="text-center form-section">No colours yet</p>
    </div>
  </div>

  <div v-if="activeTab === 'code'">
    <h2>Local Styles</h2>
    <p>
      All of your colours from <strong>Local Styles</strong> will be generated here.
    </p>
    <p>
      If you manually add or remove styles, click <strong>Refresh</strong>.
    </p>
    <button @click="refreshLocalStyles">Refresh</button>

    <div v-if="store.codeBlocks.length" class="form-section code-layout" v-if="codeBlocks.length">
      <div class="code-layout__item" v-for="codeBlock in store.codeBlocks">
        <div class="code-layout__title">
          <h3>{{codeBlock.name}}</h3>

          <button class="small" @click="copyCodeToClipboard(codeBlock)">
            Copy
          </button>
        </div>

        <div class="code-wrapper">
          <pre class="code-block">{{codeBlock.code}}</pre>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- <button id="export-palette">Export styles to colour palette</button> -->
